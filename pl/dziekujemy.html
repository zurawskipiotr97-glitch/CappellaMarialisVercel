<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Dziękujemy za wsparcie – Cappella Marialis</title>
  <meta name="description" content="Dziękujemy za wsparcie Fundacji Cappella Marialis. Sprawdzamy status płatności." />

  <link rel="stylesheet" href="../style.css" />

  <link rel="icon" href="../favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" href="../favicon-48.png" sizes="48x48" />
  <link rel="icon" type="image/png" href="../images/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="../images/android-chrome-192x192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="../images/apple-touch-icon.png" sizes="180x180" />
  <link rel="manifest" href="../site.webmanifest" />
  <meta name="theme-color" content="#0f3460" />

  <style>
    .p24-card{padding:16px;border:1px solid rgba(0,0,0,.12);border-radius:12px}
    .p24-muted{opacity:.85}
    .p24-row{display:flex;gap:10px;flex-wrap:wrap}
    .p24-row>div{min-width:220px}
    .p24-badge{display:inline-block;padding:.18rem .55rem;border-radius:999px;border:1px solid rgba(0,0,0,.18)}
  </style>
</head>

<body>
  <a href="#main-content" class="skip-link">Przejdź do treści</a>

  <h1 class="visually-hidden">Dziękujemy za wsparcie</h1>

  <!-- HEADER (spójny z regulamin.html) -->
  <header>
    <div class="header-logo">
      <a href="../index.html">
        <img src="../images/CM_logo.png" alt="Cappella Marialis Logo" />
      </a>
    </div>

    <div class="lang-switcher">
      <a href="../index.html" class="lang">Strona Główna</a>
      <span class="separator">|</span>
      <a href="../pl/dziekujemy.html" class="lang">PL</a>
      <span class="separator">|</span>
      <a href="../en/thank-you.html" class="lang">EN</a>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container" id="main-content">
    <section style="margin-bottom: 0rem;">
      <h2>Dziękujemy!</h2>
      <p class="p24-muted">Sprawdzamy status Twojej wpłaty. Jeśli dopiero co wróciłeś z płatności, może to chwilę potrwać.</p>

      <div class="p24-card">
        <p id="status" class="p24-muted">Sprawdzam status płatności…</p>

        <div id="details" style="display:none">
          <div class="p24-row">
            <div><strong>Numer wpłaty:</strong> <span id="ref"></span></div>
            <div><strong>Kwota:</strong> <span id="amt"></span></div>
            <div><strong>Status:</strong> <span id="st" class="p24-badge"></span></div>
          </div>
          <p class="p24-muted" style="margin-top:12px">Jeśli status nie zmieni się w ciągu kilku minut, odśwież stronę lub skontaktuj się z nami.</p>
        </div>
      </div>

      <div style="margin-top: 14px;">
        <a class="album-link" href="../index.html#wesprzyj">Wróć do strony głównej</a>
      </div>
    </section>
  </main>

  <!-- FOOTER (spójny z regulamin.html) -->
  <footer id="rodo-footer">
    <p style="color: #d4af37"><strong>Cappella&nbsp;Marialis</strong></p>

    <a href="regulamin.html" class="album-link" style="margin-right: 5px;">Regulamin Sprzedaży</a>
    <a href="prywatnosc.html" class="album-link" style="margin-right: 5px;">Privacy Policy</a>
    <a href="rodo.html" class="album-link" style="margin-right: 5px;">Klauzura RODO</a>
    <a href="dostepnosc.html" class="album-link" style="margin-right: 5px;">Deklaracja dostępności</a>
    <a href="kontakt.html" class="album-link">Dane kontaktowe</a>

    <p class="copyright">© 2025 Cappella Marialis. Wszelkie prawa zastrzeżone.</p>
  </footer>

  <button id="scrollToTop" aria-label="Wróć na górę" type="button">
    <svg class="to-top-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M12 5l-7 7m7-7l7 7M12 5v14" fill="none" stroke="currentColor" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <script>
    (function(){
      const statusEl = document.getElementById('status');
      const detailsEl = document.getElementById('details');
      const refEl = document.getElementById('ref');
      const amtEl = document.getElementById('amt');
      const stEl = document.getElementById('st');

      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('sessionId');

      function fmtAmount(grosze, currency){
        const n = Number(grosze);
        if (!Number.isFinite(n)) return '';
        return (n/100).toFixed(2) + ' ' + (currency || 'PLN');
      }

      function isProbablyLocalFile(){
        return window.location && window.location.protocol === 'file:';
      }

      async function poll(){
        if (!sessionId){
          statusEl.textContent = 'Brak identyfikatora płatności (sessionId).';
          return;
        }

        if (isProbablyLocalFile()){
          // Local preview fallback
          statusEl.textContent = 'Podgląd lokalny: tutaj normalnie sprawdzamy status w /api/p24/check. Po deployu na Vercel status będzie aktualizowany automatycznie.';
          detailsEl.style.display = '';
          refEl.textContent = sessionId;
          amtEl.textContent = '—';
          stEl.textContent = 'pending';
          return;
        }

        try{
          const r = await fetch('/api/p24/check?sessionId=' + encodeURIComponent(sessionId), { cache: 'no-store' });
          const j = await r.json();
          const tx = j && j.transaction;

          if (!tx){
            statusEl.textContent = 'Nie znaleziono płatności. Jeśli dopiero płacisz – odśwież za chwilę.';
            return;
          }

          detailsEl.style.display = '';
          refEl.textContent = tx.public_ref || tx.session_id || sessionId;
          amtEl.textContent = fmtAmount(tx.amount_grosze, tx.currency);
          stEl.textContent = tx.status;
          statusEl.textContent = (tx.status === 'paid')
            ? 'Płatność potwierdzona. Dziękujemy za wsparcie!'
            : (tx.status === 'failed')
              ? 'Płatność nie została potwierdzona.'
              : 'Płatność w trakcie weryfikacji…';

        } catch (e){
          statusEl.textContent = 'Nie udało się sprawdzić statusu. Spróbuj ponownie za chwilę.';
        }
      }

      poll();
      setInterval(poll, 3000);
    })();

    (function() {
      const scrollBtn = document.getElementById('scrollToTop');
      if (!scrollBtn) return;

      function reduceMotion() {
        return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      }

      function updateVisibility() {
        scrollBtn.classList.toggle('is-visible', window.scrollY > 400);
      }

      window.addEventListener('scroll', updateVisibility, { passive: true });
      updateVisibility();

      let pending = false;

      function goTopNow(e) {
        if (pending) return;
        pending = true;

        if (e && typeof e.preventDefault === 'function') e.preventDefault();

        const behavior = reduceMotion() ? 'auto' : 'smooth';

        window.scrollTo({ top: window.scrollY, behavior: 'auto' });
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            window.scrollTo({ top: 0, behavior });
            setTimeout(() => { pending = false; }, 250);
          });
        });
      }

      scrollBtn.addEventListener('pointerdown', goTopNow, { passive: false });
      scrollBtn.addEventListener('touchstart', goTopNow, { passive: false });
      scrollBtn.addEventListener('click', goTopNow);
    })();
  </script>
</body>
</html>