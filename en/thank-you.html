<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Thank you for your donation – Cappella Marialis</title>
  <meta name="description" content="Thank you for supporting the Cappella Marialis Foundation. We are checking your payment status." />

  <link rel="stylesheet" href="../style.css" />

  <link rel="icon" href="../favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" href="../favicon-48.png" sizes="48x48" />
  <link rel="icon" type="image/png" href="../images/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="../images/android-chrome-192x192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="../images/apple-touch-icon.png" sizes="180x180" />
  <link rel="manifest" href="../site.webmanifest" />
  <meta name="theme-color" content="#0f3460" />

  <style>
    .p24-card{padding:16px;border:1px solid rgba(0,0,0,.12);border-radius:12px}
    .p24-muted{opacity:.85}
    .p24-row{display:flex;gap:10px;flex-wrap:wrap}
    .p24-row>div{min-width:220px}
    .p24-badge{display:inline-block;padding:.18rem .55rem;border-radius:999px;border:1px solid rgba(0,0,0,.18)}
  </style>
</head>

<body>
  <a href="#main-content" class="skip-link">Skip to content</a>

  <h1 class="visually-hidden">Thank you</h1>

  <!-- HEADER (aligned with terms.html layout) -->
  <header>
    <div class="header-logo">
      <a href="../en.html">
        <img src="../images/CM_logo.png" alt="Cappella Marialis Logo" />
      </a>
    </div>

    <div class="lang-switcher">
      <a href="../en.html" class="lang">Home Page</a>
      <span class="separator">|</span>
      <a href="../pl/dziekujemy.html" class="lang">PL</a>
      <span class="separator">|</span>
      <a href="../en/thank-you.html" class="lang">EN</a>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container" id="main-content">
    <section style="margin-bottom: 0rem;">
      <h2>Thank you!</h2>
      <p class="p24-muted">We’re verifying your payment status.</p>

      <div class="p24-card">
        <p id="status" class="p24-muted">Checking payment status…</p>

        <div id="details" style="display:none">
          <div class="p24-row">
            <div><strong>Donation reference:</strong> <span id="ref"></span></div>
            <div><strong>Amount:</strong> <span id="amt"></span></div>
            <div><strong>Status:</strong> <span id="st" class="p24-badge"></span></div>
          </div>
          <p class="p24-muted" style="margin-top:12px">If the status doesn’t update within a few minutes, refresh the page or contact us.</p>
        </div>
      </div>

      <p class="p24-muted" style="margin-top: 14px;">
        <strong>Note:</strong> when opened locally from disk, the status check won’t work (the /api endpoints run only after deploy on Vercel).
      </p>
    </section>
  </main>

  <!-- FOOTER (aligned with terms.html) -->
  <footer id="rodo-footer">
    <p style="color: #d4af37"><strong>Cappella&nbsp;Marialis</strong></p>

    <a href="terms.html" class="album-link" style="margin-right: 5px;">Terms</a>
    <a href="privacy.html" class="album-link" style="margin-right: 5px;">Privacy Policy</a>
    <a href="GDPR.html" class="album-link" style="margin-right: 5px;">GDPR clause</a>
    <a href="accessibility.html" class="album-link" style="margin-right: 5px;">Accessibility statement</a>
    <a href="contact.html" class="album-link">Contact</a>

    <p class="copyright">© 2025 Cappella Marialis. All rights reserved.</p>
  </footer>

  <button id="scrollToTop" aria-label="Back to top" type="button">
    <svg class="to-top-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M12 5l-7 7m7-7l7 7M12 5v14" fill="none" stroke="currentColor" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <script>
    (function(){
      const statusEl = document.getElementById('status');
      const detailsEl = document.getElementById('details');
      const refEl = document.getElementById('ref');
      const amtEl = document.getElementById('amt');
      const stEl = document.getElementById('st');

      const params = new URLSearchParams(location.search);
      const sessionId = params.get('sessionId');

      function fmtAmount(grosze, currency){
        const n = Number(grosze);
        if (!Number.isFinite(n)) return '';
        return (n/100).toFixed(2) + ' ' + (currency || 'PLN');
      }

      function isProbablyLocalFile(){
        return window.location && window.location.protocol === 'file:';
      }

      async function poll(){
        if (!sessionId){
          statusEl.textContent = 'Missing payment identifier (sessionId).';
          return;
        }

        if (isProbablyLocalFile()){
          statusEl.textContent = 'Local preview: payment status is unavailable.';
          detailsEl.style.display = 'block';
          refEl.textContent = '—';
          amtEl.textContent = '—';
          stEl.textContent = 'preview';
          return;
        }

        try{
          const r = await fetch('/api/p24/check?sessionId=' + encodeURIComponent(sessionId), { cache: 'no-store' });
          const j = await r.json();
          const tx = j && j.transaction;

          if (!tx){
            statusEl.textContent = 'Payment not found. If you just paid, refresh in a moment.';
            return;
          }

          detailsEl.style.display = 'block';
          refEl.textContent = tx.public_ref || tx.session_id || '';
          amtEl.textContent = fmtAmount(tx.amount_grosze, tx.currency);
          stEl.textContent = tx.status || '';

          if (tx.status === 'paid'){
            statusEl.textContent = 'Payment confirmed. Thank you for your support!';
            return; // stop polling
          }

          statusEl.textContent = 'Payment status: ' + (tx.status || 'unknown') + '. Refreshing…';
          setTimeout(poll, 2500);
        } catch (e){
          statusEl.textContent = 'Could not check status. Please try again later.';
          setTimeout(poll, 4000);
        }
      }

      poll();
    })();

    (function() {
      const scrollBtn = document.getElementById('scrollToTop');
      if (!scrollBtn) return;

      function reduceMotion() {
        return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      }

      function updateVisibility() {
        scrollBtn.classList.toggle('is-visible', window.scrollY > 400);
      }

      window.addEventListener('scroll', updateVisibility, { passive: true });
      updateVisibility();

      let pending = false;

      function goTopNow(e) {
        if (pending) return;
        pending = true;

        if (e && typeof e.preventDefault === 'function') e.preventDefault();

        const behavior = reduceMotion() ? 'auto' : 'smooth';
        window.scrollTo({ top: window.scrollY, behavior: 'auto' });
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            window.scrollTo({ top: 0, behavior });
            setTimeout(() => { pending = false; }, 250);
          });
        });
      }

      scrollBtn.addEventListener('pointerdown', goTopNow, { passive: false });
      scrollBtn.addEventListener('touchstart', goTopNow, { passive: false });
      scrollBtn.addEventListener('click', goTopNow);
    })();
  </script>
</body>
</html>
