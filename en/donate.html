<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Donation – Cappella Marialis</title>
  <meta name="description" content="Make a donation to the Cappella Marialis Foundation via Przelewy24." />

  <link rel="stylesheet" href="../style.css" />

  <link rel="icon" href="../favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" href="../favicon-48.png" sizes="48x48" />
  <link rel="icon" type="image/png" href="../images/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="../images/android-chrome-192x192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="../images/apple-touch-icon.png" sizes="180x180" />
  <link rel="manifest" href="../site.webmanifest" />
  <meta name="theme-color" content="#0f3460" />

  <style>
    .p24-card{padding:16px;border:1px solid rgba(0,0,0,.12);border-radius:12px}
    .p24-grid{display:grid;grid-template-columns:1fr;gap:12px}
    .p24-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .p24-row>*{flex:1 1 auto}
    .p24-amounts{display:flex;gap:10px;flex-wrap:wrap}
    /* Amount presets (gold, but subtle) */
    .p24-amounts button{padding:.65rem .9rem;border-radius:999px;border:1px solid rgba(212,175,55,.75);background:linear-gradient(135deg, rgba(212,175,55,.22), rgba(245,224,142,.38));cursor:pointer;color:#2b2000;font-weight:600}
    .p24-amounts button:hover{filter:brightness(1.05)}
    .p24-amounts button.is-active{border-color:rgba(212,175,55,1);background:linear-gradient(135deg, rgba(212,175,55,.32), rgba(245,224,142,.55));box-shadow:0 0 0 2px rgba(212,175,55,.22)}
    .p24-input{width:100%;padding:.7rem .9rem;border-radius:10px;border:1px solid rgba(0,0,0,.18);background:transparent}
    .p24-actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-start}
    .p24-muted{opacity:.85}
    .p24-error{color:#b00020}
    .p24-success{color:#0b6b2d}
    .p24-consents{display:grid;gap:10px;margin-top:6px}
    .p24-consents label{display:flex;gap:10px;align-items:flex-start}
    .p24-consents input{margin-top:4px}
  </style>
</head>

<body>
  <a href="#main-content" class="skip-link">Skip to content</a>

  <h1 class="visually-hidden">Donation</h1>

  <!-- HEADER (aligned with terms.html) -->
  <header>
    <div class="header-logo">
      <a href="../en.html">
        <img src="../images/CM_logo.png" alt="Cappella Marialis Logo" />
      </a>
    </div>

    <div class="lang-switcher">
      <a href="../en.html" class="lang">Home Page</a>
      <span class="separator">|</span>
      <a href="../pl/wplata.html" class="lang">PL</a>
      <span class="separator">|</span>
      <a href="../en/donate.html" class="lang">EN</a>
    </div>
  </header>

  <main class="container" id="main-content">
    <section style="margin-bottom: 0rem;">
      <h2>Support the Foundation</h2>
      <p class="p24-muted">Choose an amount, enter your email for confirmation, and proceed to Przelewy24.</p>

      <div class="p24-card">
        <form id="donationForm" class="p24-grid" novalidate>
          <div>
            <strong>Amount</strong>
            <div class="p24-amounts" style="margin-top:10px">
              <button type="button" data-pln="20">20 PLN</button>
              <button type="button" data-pln="50">50 PLN</button>
              <button type="button" data-pln="100">100 PLN</button>
              <button type="button" data-pln="200">200 PLN</button>
            </div>
          </div>

          <div class="p24-row">
            <div style="min-width:220px">
              <label for="amountCustom"><strong>Other amount (PLN)</strong></label>
              <input id="amountCustom" class="p24-input" inputmode="decimal" autocomplete="off" placeholder="e.g. 25" />
            </div>
            <div style="min-width:260px">
              <label for="email"><strong>Email</strong> <span class="p24-muted">(for confirmation)</span></label>
              <input id="email" class="p24-input" type="email" autocomplete="email" placeholder="you@email.com" required />
            </div>
          </div>

          <div class="p24-consents">
            <label>
              <input id="consentPrivacy" type="checkbox" required />
              <span>I accept the <a href="privacy.html" target="_blank" rel="noopener noreferrer">Privacy Policy</a>.</span>
            </label>
            <label>
              <input id="consentTerms" type="checkbox" required />
              <span>I accept the <a href="terms.html" target="_blank" rel="noopener noreferrer">Terms</a>.</span>
            </label>
            <div class="p24-muted">GDPR info: <a href="GDPR.html" target="_blank" rel="noopener noreferrer">information clause</a>.</div>
          </div>

          <div class="p24-actions">
            <button id="payBtn" class="donate-btn" type="submit">Proceed to payment</button>
            <a class="album-link" href="../en.html#support">Back</a>
          </div>

          <p id="msg" class="p24-muted" role="status" aria-live="polite"></p>
        </form>
      </div>

      <p class="p24-muted" style="margin-top: 14px;">
        <strong>Note:</strong> when you open this page locally from disk, payments won't work (the /api endpoints are available only after deploying to Vercel).
      </p>
    </section>
  </main>

  <footer>
    <p style="color: #d4af37"><strong>Cappella&nbsp;Marialis</strong></p>

    <a href="terms.html" class="album-link" style="margin-right: 5px;">Terms</a>
    <a href="privacy.html" class="album-link" style="margin-right: 5px;">Privacy Policy</a>
    <a href="GDPR.html" class="album-link" style="margin-right: 5px;">GDPR</a>
    <a href="accessibility.html" class="album-link" style="margin-right: 5px;">Accessibility statement</a>
    <a href="contact.html" class="album-link">Contact</a>

    <p class="copyright">© 2025 Cappella Marialis. All rights reserved.</p>
  </footer>

  <button id="scrollToTop" aria-label="Back to top" type="button">
    <svg class="to-top-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M12 5l-7 7m7-7l7 7M12 5v14" fill="none" stroke="currentColor" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <script>
    (function(){
      const form = document.getElementById('donationForm');
      const amountCustom = document.getElementById('amountCustom');
      const email = document.getElementById('email');
      const consentPrivacy = document.getElementById('consentPrivacy');
      const consentTerms = document.getElementById('consentTerms');
      const msg = document.getElementById('msg');
      const payBtn = document.getElementById('payBtn');

      let selectedPln = null;

      function setMsg(text, kind){
        msg.className = 'p24-muted';
        if (kind === 'error') msg.classList.add('p24-error');
        if (kind === 'success') msg.classList.add('p24-success');
        msg.textContent = text || '';
      }

      function setActive(btn){
        document.querySelectorAll('.p24-amounts button').forEach(b => b.classList.remove('is-active'));
        if (btn) btn.classList.add('is-active');
      }

      document.querySelectorAll('.p24-amounts button').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedPln = Number(btn.getAttribute('data-pln'));
          amountCustom.value = '';
          setActive(btn);
          setMsg('Selected: ' + selectedPln + ' PLN');
        });
      });

      amountCustom.addEventListener('input', () => {
        selectedPln = null;
        setActive(null);
      });

      function parsePln(){
        if (selectedPln && Number.isFinite(selectedPln)) return selectedPln;
        const raw = (amountCustom.value || '').trim().replace(',', '.');
        if (!raw) return null;
        const n = Number(raw);
        if (!Number.isFinite(n)) return null;
        return n;
      }

      function isProbablyLocalFile(){
        return window.location && window.location.protocol === 'file:';
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setMsg('');

        const pln = parsePln();
        const em = (email.value || '').trim();

        if (!pln || pln <= 0){
          setMsg('Please enter a valid amount.', 'error');
          return;
        }
        if (!em){
          setMsg('Please enter your email.', 'error');
          return;
        }
        if (!consentPrivacy.checked || !consentTerms.checked){
          setMsg('Please accept the required consents (Privacy Policy and Terms).', 'error');
          return;
        }

        if (isProbablyLocalFile()){
          setMsg('Local preview: the form is for layout only. Payments will work after deploying to Vercel.', 'success');
          return;
        }

        const amountGrosze = Math.round(pln * 100);
        payBtn.disabled = true;
        payBtn.textContent = 'Redirecting...';

        try{
          const res = await fetch('../api/p24/create', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({
              amountGrosze,
              email: em,
              consents: { privacy: true, terms: true },
              consentsVersion: '2026-01-19',
              meta: { page: 'en/donate' }
            })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok){
            throw new Error(data && data.error ? data.error : 'Unable to start payment.');
          }
          if (!data.redirectUrl){
            throw new Error('Missing redirectUrl from backend.');
          }
          window.location.href = data.redirectUrl;
        } catch (err){
          setMsg(err && err.message ? err.message : 'An error occurred.', 'error');
          payBtn.disabled = false;
          payBtn.textContent = 'Proceed to payment';
        }
      });
    })();

    (function() {
      const scrollBtn = document.getElementById('scrollToTop');
      if (!scrollBtn) return;

      function reduceMotion() {
        return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      }

      function updateVisibility() {
        scrollBtn.classList.toggle('is-visible', window.scrollY > 400);
      }

      window.addEventListener('scroll', updateVisibility, { passive: true });
      updateVisibility();

      let pending = false;

      function goTopNow(e) {
        if (pending) return;
        pending = true;

        if (e && typeof e.preventDefault === 'function') e.preventDefault();

        const behavior = reduceMotion() ? 'auto' : 'smooth';

        window.scrollTo({ top: window.scrollY, behavior: 'auto' });
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            window.scrollTo({ top: 0, behavior });
            setTimeout(() => { pending = false; }, 250);
          });
        });
      }

      scrollBtn.addEventListener('pointerdown', goTopNow, { passive: false });
      scrollBtn.addEventListener('touchstart', goTopNow, { passive: false });
      scrollBtn.addEventListener('click', goTopNow);
    })();
  </script>
</body>
</html>